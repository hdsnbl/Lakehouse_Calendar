@page "/"
@* @inject Request request; *@
@* @inject CalendarItem items; *@
@inject ICalendar calendar;
@inject ApiService apiService;
@inject NavigationManager NavigationManager;

<PageTitle>Calendar</PageTitle>

<div style="display: flex; align-items: center; justify-content: space-between;">
    <h1 style=" margin: 0 auto; text-align: center; flex: 1;">Allen Lakehouse Calendar</h1>
    <MudButton Color="Color.Dark" Variant="Variant.Filled" @onclick="() => CreateUser()">
        Create User
    </MudButton>
</div>


<MudMessageBox @ref="_mudMessageBox" Title="@GetModalTitle()" CancelText="Close">
    <MessageContent>
        @if (selectedItems?.Any() == true)
        {
            <MudPaper>
                <MudList T="CalendarItem">
                    @foreach (var item in selectedItems)
                    {
                        <MudListItem style="
                                border: 1px solid #bbb;
                                border-radius: 8px;
                                padding: 10px;
                                background-color: #fff;
                                text-align: center;
                                align-content: right;
                            ">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <p style=" margin: 0 auto; text-align: center; flex: 1;">
                                    <strong>@item.Name</strong>
                                </p>
                                <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                                           @onclick="() => ConfirmDisapprove(item)">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" />
                                </MudButton>
                            </div>
                            
                            @if (item.Notes != null)
                            {
                                <p><strong>Notes:</strong> @item.Notes</p>
                            }
                            else
                            {
                                <p>There are no notes here.</p>
                            }
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        }
        else
        {
            <p>No events for this day.</p>
        }
    </MessageContent>
</MudMessageBox>
<MudMessageBox @ref="_confirmBox" Title="Confirm Disapproval" YesText="Yes" NoText="Cancel">
    <MessageContent>
        <p>Are you sure you want to disapprove <strong>@(itemToDisapprove?.Name)</strong>?</p>
    </MessageContent>
</MudMessageBox>

<div style="display: flex; align-items: center; justify-content: space-between;">
    <MudButton Variant="Variant.Filled" Size="Size.Medium" Color="Color.Dark" style="width: 14.5%" @onclick="() => { monthsAway--; CreateMonth(); }">Previous Month</MudButton>               @* need to change *@
    <h2>@monthName, @year</h2>
    <MudButton Variant="Variant.Filled" Size="Size.Medium" Color="Color.Dark" style="width: 14.5%" @onclick="() => { monthsAway++; CreateMonth(); }">Next Month</MudButton>
</div>

<MudPaper Elevation="11" style="background-color: lightyellow; padding: 20px;">
    <section style="
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 0;
                width: 100%;
            ">
        @for (int i = 0; i < numDummyColumn; i++)
        {
            <div class="clickable-box"></div>
        }

        @for (int i = 1; i <= monthEnd.Day; i++)
        {
            var dayDate = new DateTime(year, month, i);
            var dayItems = calendar.Items.Where(n => n.Date.Date == dayDate.Date).ToList();

            var backgroundColor = dayItems.Any()
            ? (dayItems.Any(n => n.Exclusive == true) ? "indianred" : "lightgreen")
            : "lightyellow";

            <div class="clickable-box" style="background-color: @backgroundColor;"
                 @onclick="() => OpenDayItems(dayDate)">
                <h2>@i</h2>
                @if (dayItems.Any())
                {
                    <p>@string.Join(", ", dayItems.Select(n => n.Name))</p>
                }
            </div>
        }
    </section>
</MudPaper>

<style>
    .clickable-box {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }

    .clickable-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        background-color: #f0f0f0;
    }

    .clickable-box:active {
        transform: translateY(0);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
</style>


@code{
    string monthName = "";
    DateTime monthEnd;
    int numDummyColumn = 0;
    int monthsAway = 0;
    int year = 2025;
    int month = 0;
    private MudMessageBox _mudMessageBox;
    private List<CalendarItem> selectedItems = new();
    private DateTime? selectedDate;
    private MudMessageBox _confirmBox;
    private CalendarItem? itemToDisapprove;

    List<CalendarItem> monthlyItems = new List<CalendarItem>();
    List<Calendar> daysOfMonth = new List<Calendar>();

    protected override void OnInitialized()
    {
        calendar.Items = ApiService.GetAllCalendarEvents();
        CreateMonth();
    }

    void CreateUser()
    {
        //ApiService.CreateUser("test", "testing", true, null);
        NavigationManager.NavigateTo("/createUser");
    }

    private async Task ConfirmDisapprove(CalendarItem item)
    {
        itemToDisapprove = item;
        bool? confirmed = await _confirmBox.ShowAsync();

        if (confirmed == true)
        {
            await DisapproveItem(item);
            //await _mudMessageBox.CloseAsync();
        }
        calendar.Items = ApiService.GetAllCalendarEvents()
            .Where(item => item.Approved == true)
            .ToList();

        //StateHasChanged();
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

    private async Task DisapproveItem(CalendarItem item)
    {
        item.Approved = false;
        ApiService.UpdateCalendarEvent(item);

        // Refresh items for the modal view
        selectedItems = calendar.Items
            .Where(n => n.Date.Date == selectedDate?.Date)
            .ToList();

        
        
    }

    private string GetModalTitle()
    {
        return selectedDate.HasValue ? selectedDate.Value.ToString("MMMM dd, yyyy") : "No date selected";
    }

    private async Task OpenDayItems(DateTime date)
    {
        selectedDate = date;
        selectedItems = calendar.Items
            .Where(n => n.Date.Date == date.Date)
            .ToList();

        StateHasChanged();
        await Task.Yield();

        await _mudMessageBox.ShowAsync();
    }

    void CreateMonth()
    {
        monthlyItems.Clear();
        daysOfMonth.Clear();

        var tempDate = DateTime.Now.AddMonths(monthsAway);
        month = tempDate.Month;
        year = tempDate.Year;

        DateTime monthStart = new DateTime(year, month, 1);
        monthEnd = monthStart.AddMonths(1).AddDays(-1);
        monthName = monthStart.Month switch
        {
            1 => "January",
            2 => "February",
            3 => "March",
            4 => "April",
            5 => "May",
            6 => "June",
            7 => "July",
            8 => "August",
            9 => "September",
            10 => "October",
            11 => "November",
            12 => "December",
            _ => ""
        };

        var apiItems = ApiService.GetCalendarEvents(monthStart, monthEnd);

        foreach (var apiitem in apiItems)
        {
            bool exists = calendar.Items.Any(n => n.Date == apiitem.Date && n.Name == apiitem.Name);
            if (!exists)
            {
                calendar.Items.Add(apiitem);
            }
        }
        calendar.Items = calendar.Items
            .Where(item => item.Approved == true)
            .ToList();

        numDummyColumn = (int)monthStart.DayOfWeek;
    }
}
